version: "3.9"

services:
  proxy:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8080:8080"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 2s
      timeout: 1s
      retries: 30

  echo:
    build:
      context: .
      dockerfile: cmd/echo-server/Dockerfile
    ports:
      - "9000:9000"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/health"]
      interval: 2s
      timeout: 1s
      retries: 30

  # Все тесты - запускаются одной командой
  test:
    image: golang:1.22-alpine
    working_dir: /app
    volumes:
      - .:/app
    depends_on:
      proxy:
        condition: service_healthy
      echo:
        condition: service_healthy
    environment:
      - PROXY_ADDR=proxy:8080
      - ECHO_ADDR=echo:9000
    command: ["go", "test", "./...", "-v", "-count=1"]

